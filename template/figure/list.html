<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>[[${str}]] | 轮播图设置</title>
<link th:href="@{{sp}/css/bootstrap.min.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/font-awesome/css/font-awesome.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/animate.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/style.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/jqui1114/jquery-ui.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/plugins/select2/select2.min.css(sp=${pub_bucket})}" rel="stylesheet">
<script th:src="@{{sp}/kindeditor/kindeditor-min.js(sp=${pub_bucket})}"> </script>
</head>

<body>
	<div id="wrapper">
		<div th:replace="../common/nav"></div>
		<div id="page-wrapper" class="gray-bg">
			<div th:replace="../common/top"></div>   <!-- 顶部 -->
			<div class="row wrapper border-bottom white-bg page-heading" >  <!-- tab栏目 -->
				<div class="col-sm-4">
					<h2 th:if="${type==0000}">公众号轮播图设置</h2>
					<h2 th:if="${type==1000}">收银台轮播图设置</h2>
					 <h2><button type="button" class="btn btn-primary back">返回上一页</button></h2>
					 <p th:if="${type==0000}">提示：公众号最多显示5张轮播图</p>
					 <p th:if="${type==1000}">提示：收银台最多显示5张轮播图</p>
					 <p></p>
					<ol class="breadcrumb">
					</ol>
				</div>
			</div>
			<div class="row">
                        <div class="col-md-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2><button type="button" class="btn btn-warning add_new_market">添加轮播图</button></h2>
                                </div>
                                <div class="x_content">                                    
                                    <!-- content here -->
                                            <table class="table table-striped table-hover table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>图片</th>
                                                        <th>标题</th>
                                                        <th>简介</th>
                                                        <th>上线时间</th>
                                                        <th>下线时间</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                      <div class="text-c odd" role="row" th:each="r, rStat: ${page.result}">
                                                        <tr>
                                                             <td>[[${rStat.count}]]</td>
                                                             <td>
                                                               <a href="javascript:void(0)">
																 <img th:if="${r.picture!=null&&r.picture!=''}" alt="image" class="img-circle" th:src="|${root_path}/${r.picture}|" width="38px" height="38px">
																</a>
                                                             </td>
                                                             <td>
                                                       		   <p>[[${r.title}]]</p>
                                                             </td>
                                                             <td>
                                                                <p>[[${r.info}]]</p>
                                                             </td>
                                                             <td>
																<a th:if="${r.start_time }!=null"  class="time_edit" th:attr="start_time=${r.start_time},end_time=${r.end_time},id=${r.id}">[[${r.start_time }]]
																</a>
																<a th:if="${r.start_time }==null" class="time_edit" th:attr="start_time=${r.start_time},end_time=${r.end_time},id=${r.id}">未设置</a>
															 </td>
															 <td>
																<a th:if="${r.end_time }!=null"   class="time_edit" th:attr="start_time=${r.start_time},end_time=${r.end_time},id=${r.id}">[[${r.end_time }]]
																</a>
																<a th:if="${r.end_time }==null" class="time_edit" th:attr="start_time=${r.start_time},end_time=${r.end_time},id=${r.id}">未设置</a>
                                                             </td>
                                                             <td>
                                                                <a href="javascript:void(0)" th:attr_mt="${r.type}" th:attr_id="${r.id}" class="glyphicon glyphicon-trash fash_del">删除</a>
                                                            </td>
                                                        </tr>
                                                      </div> 
                                                </tbody>
                                            </table>
                                            <div th:replace="../common/page"></div>
                                    <!-- content here -->
                                </div>
                            </div>
                        </div>
                    </div>
			<div th:replace="../common/foot"></div>  <!-- 页脚 -->
		</div>
	</div>
	
	<div id="templatemo-preferences-form" style="display:none;padding-left:15px;padding-right:15px">
		<input id="id" type="hidden">
		<div class="col-md-12 margin-bottom-15" style="font-size:15px;position: fixed;top: 70px;right: -95px;">
                              标题:&nbsp;<input type="text"  id="title" value="" placeholder="输入标题，此为必填项" style="width:50%">
		</div>
		<div class="col-md-12 margin-bottom-15" style="font-size:15px;position: fixed;top: 120px;right: -95px;">
				简介:&nbsp;<input type="text"  id="info" placeholder="请输入简介" style="width:50%">
		</div>
		<div class="col-md-12 margin-bottom-15" id="url_div" style="font-size:15px;position: fixed;top: 170px;right: -65px;">
				点击链接:&nbsp;<input type="text" id="url_msg" value="" placeholder="请输入点击链接" style="width:50%">
		</div>
		<div class="col-md-12 margin-bottom-15" id="type_div" style="font-size:15px;position: fixed;top: 220px;right: -95px;">
				类型:&nbsp;<select id="figure_type" style="width:20%">
						<option value="00">轮播</option>	
						<!-- <option value="10">弹窗</option>	 -->	
				</select>
		</div>
		<div class="col-md-12 margin-bottom-15" id="file_div" style="font-size:15px;position: fixed;top: 270px;right: -65px;">
				显示图片:&nbsp;<input type="file"  id="picture" style="width:40%;position: fixed;top: 270px;left:155px;">
				<div id="result" style="font-size:15px;position: fixed;top: 305px;left:155px;"></div>
		</div>
		<div class="row templatemo-form-buttons" id="save_div" style="margin-top:15px;font-size:15px;position: fixed;top: 400px;left: 220px;" >
			<div class="col-md-12">
				<button id="save" data-style="zoom-in" class="ladda-button btn btn-primary" style="width:120px;">保存</button>
			</div>
		</div>
	</div>
	
	<div id="templatemo-preferences-form-time" style="display:none;padding-left:15px;padding-right:15px; margin-bottom: 30px; max-width: 960px;">
		<div class="row" style="font-size:15px;">
            <div class="col-md-12 margin-bottom-15"  style="font-size:15px;position: fixed;top: 70px;right: -135px;">
             	    开始时间:&nbsp;<input name="start_time" type="text"  id="start_time" placeholder="请设置活动开始时间" readonly> 
            </div>
            <div class="col-md-12 margin-bottom-15" style="font-size:15px;position: fixed;top: 120px;right: -135px;">
           		  结束时间:&nbsp;<input name="end_time" type="text"  id="end_time" placeholder="请设置活动结束时间" readonly>
            </div>
        </div>
		<div class="row templatemo-form-buttons" style="font-size:15px;position: fixed;top: 170px;left:225px;">
			<div class="col-md-12">
				<button id="submit_time" class="btn btn-primary" style="width:80px;">确认</button>
			</div>
		</div>
	</div>
	   
	  <!-- Mainly scripts -->
    <script th:src="@{{sp}/js/jquery-2.1.1.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/bootstrap.min.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/metisMenu/jquery.metisMenu.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/slimscroll/jquery.slimscroll.min.js(sp=${pub_bucket})}"></script>

    <!-- Custom and plugin javascript -->
    <script th:src="@{{sp}/js/inspinia.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/pace/pace.min.js(sp=${pub_bucket})}"></script>
    
    <script th:src="@{{sp}/third/layer3/layer.js(sp=${pub_bucket})}" type="text/javascript"></script>
    <script th:src="@{{sp}/js/plugins/select2/select2.full.min.js(sp=${pub_bucket})}" type="text/javascript"></script>
    
    <script th:src="@{{sp}/jqui1114/jquery-ui.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{{sp}/jqui1114/jquery-ui-timepicker-addon.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{{sp}/jqui1114/jquery-ui-timepicker-zh-CN.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>
</body>

<script type="text/javascript">
$(function() {
	var post_err_msg = "[[${error_msg}]]";
    if(post_err_msg){
        layer.msg(post_err_msg, {icon: 2}); 
    }
});
$(".add_new_market").on("click", function(){
	$("#title").val("");
	$("#info").val("");
	$("#url_msg").val("");
	$("#picture").val("");
	$("#result").html("");
	var f_type = '[[${type}]]'
	if(f_type=='1000'){
		$("#type_div").remove();
		$("#url_div").remove();
		var picture_box = document.getElementById("picture");
		picture_box.style="font-size:15px;position: fixed;top: 170px;left:160px;"
		var file_box = document.getElementById("file_div");
		file_box.style="font-size:15px;position: fixed;top: 170px;right: -65px;"
		var save_box = document.getElementById("save_div");
		save_box.style="font-size:15px;position: fixed;top: 320px;left: 220px;"
		var result_box = document.getElementById("result");
		result_box.style="font-size:15px;position: fixed;top: 210px;left:155px;"
		
	};
	layer.open({
		area : [ '40%', '80%'],
		type : 1,
		content : $("#templatemo-preferences-form"),
		title : "添加轮播图"
	});
});
//图片预览
function ProcessFile(e) {
     var file = document.getElementById('picture').files[0];
     $("#result").html("");
     if (file) {
         var reader = new FileReader();
         reader.onload = function (event) {
             var txt = event.target.result;
             var img = document.createElement("img");
             img.style="width:100px;height:100px;";
             img.src = txt;//将图片base64字符串赋值给img的src
             document.getElementById("result").appendChild(img);
         };
     }
     reader.readAsDataURL(file);
 }
 function contentLoaded() {
     document.getElementById('picture').addEventListener('change',
         ProcessFile, false);
 }
 window.addEventListener("DOMContentLoaded", contentLoaded, false); 
 
$(".back").on("click",function(){
	location.href = "[[${contextPath}]]/figure/index?" + Date.parse(new Date());
})
$(".fash_del").on("click",function(){
	var type=$(this).attr("attr_mt")
	var id=$(this).attr("attr_id")
	 var url="[[${contextPath}]]" + "/figure/delete_figure";
	 var index = layer.load(); 
	 $.post(url, {id:id,type:type}, function(data){
	    layer.close(index);
	       if(data.available) {
	           layer.alert('操作成功', {
	                skin: 'layui-layer-lan',
	                 shift: 4 //动画类型
	               }, function(){
	                    location.reload();
	              });
	       } else {
	           var code = data.messages[0];
	            layer.msg(code, {
	              shift : 6
	             });
	         }
	  });
});
$("#save").on("click",function(){
	var url_msg = $.trim($("#url_msg").val());
	var title = $.trim($("#title").val());
	var info = $.trim($("#info").val());
	var figure_type = $.trim($("#figure_type").val());
	var picture = document.getElementById('picture').files[0]
	var type = '[[${type}]]';
	if(url_msg){
		  var p_domain=/([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}/
		  if(!(p_domain.test(url_msg))){
			 layer.msg("输入的链接不合法", {icon: 2});
			 return;
		  }
		}
	if(title==null||title==''){
		layer.msg("标题不能为空", {icon: 2});
		return;
	}
	if(picture==''||picture==null){
		layer.msg("图片不能为空", {icon: 2});
		return;
	}
	var formData = new FormData();
    formData.append('picture', document.getElementById('picture').files[0]);
    formData.append('url_msg', url_msg);
    formData.append('info', info);
    formData.append('title', title);
    formData.append('figure_type', figure_type);
    formData.append('type', type);
    var index = layer.load();
	var url = "[[${contextPath}]]/figure/save/?" + Date.parse(new Date());
	$.ajax({
		url: url,
    	type: "POST",
    	data: formData,
   		datatype:"json",
    	contentType: false,
   		processData: false,
   		traditional: true,
    	success:function(data){
		  layer.close(index);
		  if(data.available) {
				layer.alert('操作成功', {
			        skin: 'layui-layer-lan',
			        shift: 4 //动画类型
			    }, function(){
			    	location.href = "[[${contextPath}]]/figure/edit_view?" + Date.parse(new Date())+'&type='+type;					    	
			    });
		  } else {
			  var code = data.messages[0];
	            layer.msg(code, {
	              shift : 6
	             });
	         }
    	}
	})
});
  $(".time_edit").on("click",function(){
	  var start_time = $(this).attr("start_time");
	  var end_time = $(this).attr("end_time");
	  var id = $(this).attr("id");
	  $("#id").val(id);
	  if(start_time == ''||start_time == null){
		  $("#start_time").val('');
	  }else{
		  $("#start_time").val(start_time);
	  }
	  if(end_time == ''||end_time == null){
		  $("#end_time").val('');
	  }else{
		  $("#end_time").val(end_time);
	  }
	  layer.open({
			area : [ '40%', '40%'],
			type : 1,
			content : $("#templatemo-preferences-form-time"),
			title : "修改上线和下线时间"
	 });
  });
     //开始时间
	 $("#start_time").datepicker();
     $("#start_time").datepicker("option", "showAnim", "slideDown");
     $("#start_time").datepicker("option", "dateFormat", "yy-mm-dd");
	 //结束时间
	 $("#end_time").datepicker();
     $("#end_time").datepicker("option", "showAnim", "slideDown");
     $("#end_time").datepicker("option", "dateFormat", "yy-mm-dd");
     
     //保存上线、下线时间
     $("#submit_time").on("click",function(){
    	 var start_time = $("#start_time").val();
    	 var end_time = $("#end_time").val();
    	 var id = $("#id").val();
    	 var type = '[[${type}]]'
    	 var start_date= start_time.split('-');
     	 var end_date = end_time.split('-');
     	 if(start_time == null||start_time == ''){
     		layer.msg("开始日期不能为空", {icon: 2});
            return;
     	 }
     	 if(end_time == null||end_time == ''){
      		layer.msg("结束日期不能为空", {icon: 2});
             return;
      	 }
    	 if(parseInt(start_date[0]+start_date[1]+start_date[2])>parseInt(end_date[0]+end_date[1]+end_date[2])) {
             layer.msg("结束日期必须大于开始日期", {icon: 2});
             return;
      	 }
    	var index = layer.load();
 		var url = "[[${contextPath}]]/figure/save_time/?" + Date.parse(new Date());
    	$.post(url,{
    		id:id,
    		start_time:start_time,
    		end_time:end_time
    	    },function(data){
    	    layer.close(index);
    		if(data.available) {
    			layer.alert('操作成功', {
    		    skin: 'layui-layer-lan',
    			shift: 4 //动画类型
    		  }, function(){
    			    location.reload();
    		   });
    		 } else {
    			 var code = data.messages[0];
    			 var msg = code;
    			 layer.msg(msg, {
    			    shift : 6
    		   });
    		}
    	})
     });
  </script>
</html>
