<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>编辑卡券批次规则 </title>
<link th:href="@{{sp}/css/bootstrap.min.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/font-awesome/css/font-awesome.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/animate.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/style.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/jqui1114/jquery-ui.css(sp=${pub_bucket})}" rel="stylesheet">
<link th:href="@{{sp}/css/plugins/select2/select2.min.css(sp=${pub_bucket})}" rel="stylesheet">
<script th:src="@{{sp}/kindeditor/kindeditor-min.js(sp=${pub_bucket})}"> </script>
</head>
<script>
    var editor;
    KindEditor.ready(function(K) {
        editor = K.create('textarea[name="coupon_content"]', {
            allowFileManager : true
        });
        K('input[name=getHtml]').click(function(e) {
            alert(editor.html());
        });
        K('input[name=isEmpty]').click(function(e) {
            alert(editor.isEmpty());
        });
        K('input[name=getText]').click(function(e) {
            alert(editor.text());
        });
        K('input[name=selectedHtml]').click(function(e) {
            alert(editor.selectedHtml());
        });
        K('input[name=setHtml]').click(function(e) {
            editor.html('<h3>Hello KindEditor</h3>');
        });
        K('input[name=setText]').click(function(e) {
            editor.text('<h3>Hello KindEditor</h3>');
        });
        K('input[name=insertHtml]').click(function(e) {
            editor.insertHtml('<strong>插入HTML</strong>');
        });
        K('input[name=appendHtml]').click(function(e) {
            editor.appendHtml('<strong>添加HTML</strong>');
        });
        K('input[name=clear]').click(function(e) {
            editor.html('');
        });
        editor.html('[[${batch.content}]]');
    });
</script>
<body>
<div id="wrapper">
    <div th:replace="../../common/nav"></div>
    <div id="page-wrapper" class="gray-bg">
        <div th:replace="../../common/top"></div>
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="page-title">
                 <div class="title_left">
                     <h3>编辑卡券批次
                      <small th:each="type : ${supp_types}">
                        <a th:if="${batch.crapp == type.key}">[[${type.name}]] </a>
                        </small>
                     </h3>
                 </div>
             </div>
             <div class="col-md-12">
                 <div class="x_panel">
                     <div class="has-success has-feedback" style="margin-top:30px;font-size:15px;">
                         <div class="row">
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_no" style="float:left;width: 20%;"> 批次编号</label> 
                                 <input name="coupon_no" type="text" class="form-control" id="coupon_no" th:value="${batch.coupon_no }" placeholder="可手动输入编号，为空则自动生成" style="float:left;width: 50%;"> 

                             </div>
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_title" style="float:left;width: 20%;">卡券名称</label> 
                                 <input name="coupon_title" type="text" class="form-control" id="coupon_title" th:value="${batch.title }" placeholder="输入卡券名称" style="float:left;width: 50%;">  
                                 
                             </div>
                         </div>
                     </div>
    
                     <div class="has-success has-feedback" style="margin-top:30px;font-size:15px;">
                         <div class="row">
                             
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_info" style="float:left;width: 20%;">卡券描述</label>
                                 <input name="coupon_info" type="text" class="form-control" id="coupon_info" th:value="${batch.info }" placeholder="请输入卡券描述"  style="float:left;width: 50%;">
                                 
                             </div>
                              <div class="col-md-6 margin-bottom-15">
                                <label class="control-label" for="desi_movie" style="float:left;width: 20%;">参与影片</label> 
                                 <select name="desi_movie" class="form-control margin-bottom-15" id="desi_movie" multiple="multiple" style="float:left;width: 50%;" data-placeholder="可选择多个，不选则不限制">
                                 </select>
                             </div>
                         </div>
                     </div>
                     <hr> 
                    <!--  <div class="has-success has-feedback" style="margin-top:30px;font-size:15px;" >
                         <div class="row">
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_validate_type" style="float:left;width: 20%;">影片类型</label> 
                                 <select name="mc_l_htt " class="form-control margin-bottom-15" id="mc_l_htt" style="float:left;width: 50%;">
                                     <option  value="">不限制</option>
                                     <option  value="2D">2D</option>
                                     <option  value="3D">3D</option>
                                 </select>
                             </div>
                             <div class="col-md-6 margin-bottom-15" >
                                 <label class="control-label" for="coupon_validate_period" style="float:left;width:20%;">影厅类型</label> 
                                <select name="mc_l_ht" id="mc_l_ht" class="form-control margin-bottom-15"  style="float:left;width: 50%;" >
                                   <div class="col-md-6 margin-bottom-15" each="r : ${available_tags}">
                                     <option value="${r.key }">${r.name}</option>
                                   </div>
                                 </select> 
                               
                                   
                             </div>
                         </div>
                     </div> -->
                    <!--  <div class="has-success has-feedback" style="margin-top:30px;font-size:15px;" >
                         <div class="row">
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_validate_type" style="float:left;width: 20%;">限制影城</label> 
                                 <select name="v_mc_l_cs_v" id="v_mc_l_cs_v" class="form-control margin-bottom-15" multiple="multiple"   style="float:left;width: 50%;">
                                 </select>
                                 
                             </div> 
                             <div class="col-md-6 margin-bottom-15">
                                 <label class="control-label" for="coupon_validate_period" style="float:left;width:20%;">指定影厅</label> 
                                 <select name="desi_movie_hall" id="desi_movie_hall" class="form-control margin-bottom-15" multiple="multiple" style="float:left;width: 50%;">
                                 </select>
                                 
                             </div> 
                         </div>
                     </div>  -->
                     <div id="checked_cinema"  class="has-success has-feedback" style="font-size:15px;">
                        <div  style="float:left;padding-left: 0px;">
                         <label class="control-label" for="coupon_validate_type" style="float:left;padding-left: 0px;">参与影城</label> 
                        </div>
                        <input type="radio" id="uncheck_cinema" name="radiobutton" value="radiobutton" checked="checked" style="width: 20px;height:20px;margin-left:80px;"> 全部
                        <input type="radio" id="check_cinema" name="radiobutton" value="radiobutton" style="width: 20px;height:20px;margin-left:20px;"> 部分影城
                     </div>  
                     <div class="example" style="margin-top:10px; margin-left:1.5px;" id="check_halls">
                       </div>
                     <hr>                                                                            
                     <div class="has-success has-feedback"  style="font-size:15px;">                                         
                         <label class="control-label" style="float:left;">卡券类型</label>                                        
                         <div class="row"   style="margin-top:30px;margin-left:120px;"> 
                             <input type="radio" checked="checked" name="Sex" value="1000" id="dj" style="width: 20px;height:20px;margin-left:20px;"  />代金&nbsp;&nbsp;&nbsp;可抵值&nbsp;&nbsp;<input   id="kims_money" style="width: 110px;"  placeholder="请输入两位小数，例如：0.00" />元                                                                                                                                                                  
                         </div>
                         <div class="row"  style="margin-top:30px;margin-left:120px;">
                             <input type="radio"  name="Sex" value="3000"  id="zk" style="width: 20px;height:20px;margin-left:20px;"  />折扣&nbsp;&nbsp;&nbsp;
                             <select  >
                                 <option value="w"  >网售价格折扣</option>
                             </select>
                             <input type="text"  style="width: 80px;"    id="discount" placeholder="输入整数"/> <a>%&nbsp;&nbsp;最高可折扣&nbsp;&nbsp;&nbsp</a>      
                             <input type="text"  style="width: 95px;"    placeholder="保留两位小数" id="discount_money"/> 元                                                                          
                         </div>
                         <div class="row"  style="margin-top:30px;margin-left:120px;">
                             <input type="radio" name="Sex" value="2000"  id="dh" style="width: 20px;height:20px;margin-left:20px;"/>兑换&nbsp;&nbsp;&nbsp;
                             <input type="text"   style="width: 80px;" id="exchange_coupons" placeholder="输入整数"/>  <a>张劵兑换</a>       
                             <input type="text"   style="width: 80px;" id="exchange_movie" placeholder="输入整数"/>  <a>张影票  补</a>  
                             <input type="text"  style="width: 95px;" id = "exchange_money" placeholder="保留两位小数"/>  <a>元</a>                                                                           
                         </div>  
                       <!--   <div class="row"  style="margin-top:30px; margin-left:1.5px;">  
                             <label class="control-label" for="p_lowest" style="float:left;">最低价保护策略</label>
                             <input type="checkbox"  value="male" style="width: 20px;height:20px;margin-left:33px;" id="p_lowest" />  是否选择保护最低限价                                                                                  
                         </div> -->             
                         <div class="row"  style="margin-top:30px; margin-left:1.5px;">
                             <label class="control-label" for="quantitys_type" style="float:left;">数量策略</label>                                     
                             <select  id="quantitys_type" style="margin-left:85px;">
                                 <option value="100"  >无</option>
                                 <option value="101"  >满</option>
                                 <option value="102"  >每满</option>
                                 <option value="103"  >每笔</option>
                                 <option value="104"  >每张</option>
                             </select>
                             <input type="text"   style="width: 200px;"   id="movie_quantitys" placeholder="1"/><a id="description">张电影票</a><input type="text"  id="coupons_quantitys" style="width: 80px;"   placeholder="输入整数" />张卡劵                                                                      
                         </div>                                              
                      </div>                       
                       <div class="has-success has-feedback" style="font-size:15px;">
                          <div class="row">
                              <div class="col-md-6 margin-bottom-15">
                                  <label class="control-label" for="coupon_validate_type">券有效期</label> 
                                  <select name="coupon_validate_type" class="form-control margin-bottom-15" id="coupon_validate_type">
                                      <option value="0000">永久有效</option>
                                      <option value="0010">统一时间失效</option>
                                      <option value="1001">按领用天失效</option>
                                  </select>
                              </div>  
                              <div class="col-md-6 margin-bottom-15">
                                  <label class="control-label" for="coupon_validate_period">设置有效期</label> 
                                  <input name="coupon_validate_period" type="text" class="form-control" id="coupon_validate_period" th:value="${batch.validate_period }" placeholder="输入卡券领用后失效阈值"> 
                                  
                              </div>
                          </div>
                      </div>
                     <hr>
                     <div class="has-success has-feedback" style="margin-top:30px;font-size:15px;">                                                                                                                                                                                                             
                         <div class="row" style="margin-top:30px;">                                          
                             <div class="col-md-6 margin-bottom-15">
                                 <label for="time_policy" class="control-label" style="float:left;width: 20%;">时间段设置</label>
                                 <select class="form-control margin-bottom-15" id="time_policy" style="float:left;width: 50%;">
                                     <option value="0">全部时间有效</option>
                                     <option value="w">按周分时设置</option>
                                     <option value="d">按天分时设置</option>
                                     
                                 </select>
                             </div>
                             <div class="col-md-6 margin-bottom-15">
                                 <label for="add_time_stregy" style="float:left;width: 20%;">&nbsp;</label> 
                                 <button type="button" class="btn btn-primary form-control add_time_stregy" style="float:left;width: 50%;">添加一条</button>
                             </div>
                         </div>
                     </div>  
                     <div class="has-success has-feedback"  id = "weeks"  style="margin-top:30px;">
                           <div class="row" >
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox1" class="week_day" dis_name="周一" value="1" style="width: 20px;height:20px;"  checked > <a >周一</a>
                               </label>
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox2" class="week_day" dis_name="周二" value="2" style="width: 20px;height:20px;" checked> 周二
                               </label>
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox3" class="week_day" dis_name="周三" value="3" style="width: 20px;height:20px;"checked> 周三
                               </label>
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox3" class="week_day" dis_name="周四" value="4" style="width: 20px;height:20px;" checked> 周四
                               </label>
                                   <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox3" class="week_day" dis_name="周五" value="5" style="width: 20px;height:20px;" checked> 周五
                               </label>
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox3" class="week_day" dis_name="周六" value="6" style="width: 20px;height:20px;" checked> 周六
                               </label>
                               <label class="checkbox-inline">
                                   <input type="checkbox" id="inlineCheckbox3" class="week_day" dis_name="周日" value="7" style="width: 20px;height:20px;" checked> 周日
                               </label>                                            
                           </div>                                                                                                                                                                                                                                                                                          
                      </div>   
                     <div class="has-success has-feedback"  id="date">                                         
                         <div class="row" style="margin-top:30px;" >                                                 
                             <div class="col-md-6 margin-bottom-15">
                                 <label for="q_sd" style="float:left;width: 20%;" >开始日期：</label>
                                 <input name="q_sd" type="text" class="form-control" id="q_sd" placeholder="开始日期" style="float:left;width: 50%;">
                             </div>
                             <div class="col-md-6 margin-bottom-15">
                                 <label for="q_ed" style="float:left;width: 20%;" >结束日期：</label>
                                 <input name="q_ed" type="text" class="form-control" id="q_ed" placeholder="结束日期" style="float:left;width: 50%;">
                             </div>
                         </div>
                     </div>                                      
    
                    
                     <div class="has-success has-feedback"  id="time1" style="margin-top:30px;">                                         
                         <div class="row">
                             <div class="col-md-6 margin-bottom-15" >
                                 <label class="control-label"for="start_time" style="float:left;width: 20%;" >开始时间</label>
                                 <input type="text" class="form-control" id="start_time" placeholder="选择开始时间" style="float:left;width: 50%;"> 
                             </div>
                             <div class="col-md-6 margin-bottom-15" >
                                 <label class="control-label" for="end_time" style="float:left;width: 20%;">结束时间</label>
                                 <input type="text" class="form-control" id="end_time" placeholder="选择结束时间" style="float:left;width: 50%;">
                             </div>                                                  
                         </div>                                              
                     </div>
                      <div class="has-success has-feedback" style="margin-top:30px;" id="rule_content">                                         
                          <div class="row" id="rule_content1">
                          </div>
                     </div>
                     <!-- <div class="has-success has-feedback" style="margin-top:30px;" id="times_value">                                         
                         <div class="row" id="times_value1">
                        </div>
                    </div>  -->                               
                   <div class="has-success has-feedback">
                      <div class="row">
                           <div class="col-md-12 margin-bottom-15">
                               <label class="control-label" for="coupon_content" style="font-size:15px;">详细信息</label>
                               <textarea name="coupon_content" class="form-control" rows="3" id="coupon_content"></textarea>
                           </div>
                       </div>
                   </div>
                        <!-- 
                        <div class="row templatemo-form-buttons" >
                           <div class="col-md-12">
                               <button type="button" class="btn btn-primary save">保存</button>
                               
                               <button type="reset" class="btn btn-default">重置</button>
                               
                           </div> 
                       </div> -->
                       
                       <div th:if="${batch.cbstatus == '10' }">
                           <div class="row templatemo-form-buttons">
                               <div class="col-md-12">
                                   <button type="button" class="btn btn-primary save">保存</button>
                               </div> 
                           </div> 
                       </div>
                 </div>
             </div>
        </div> 
        <!-- <div th:replace="../../common/foot"></div> -->
    </div>
</div>
    
      
    
    <!-- Mainly scripts -->
    <script th:src="@{{sp}/js/jquery-2.1.1.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/bootstrap.min.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/metisMenu/jquery.metisMenu.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/slimscroll/jquery.slimscroll.min.js(sp=${pub_bucket})}"></script>

    <!-- Custom and plugin javascript -->
    <script th:src="@{{sp}/js/inspinia.js(sp=${pub_bucket})}"></script>
    <script th:src="@{{sp}/js/plugins/pace/pace.min.js(sp=${pub_bucket})}"></script>
    
    <script th:src="@{{sp}/third/layer3/layer.js(sp=${pub_bucket})}" type="text/javascript"></script>
    <script th:src="@{{sp}/js/plugins/select2/select2.full.min.js(sp=${pub_bucket})}" type="text/javascript"></script>
    
    <script th:src="@{{sp}/jqui1114/jquery-ui.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{{sp}/jqui1114/jquery-ui-timepicker-addon.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>
    <script th:src="@{{sp}/jqui1114/jquery-ui-timepicker-zh-CN.js(sp=${pub_bucket})}" type="text/javascript" charset="utf-8"></script>


    <script>
        $(document).ready(function() {
            // 预加载信息
            $("#coupon_validate_type").change(function(){
                $("#coupon_validate_period").datepicker("destroy");
                if($(this).val()=="0000") {
                    $("#coupon_validate_period").val("0");
                } else if($(this).val()=="0010") {
                    $("#coupon_validate_period").val("");
                    $("#coupon_validate_period").datetimepicker({  
                        dateFormat: "yy-mm-dd",  
                        showSecond: true,  
                        timeFormat: 'hh:mm:ss',  
                        stepHour: 1,  
                        stepMinute: 1,  
                        stepSecond: 1  
                    })
                } else {
                    $("#coupon_validate_period").val("");
                }
            });
            
                $("#time_policy").find("option[value='[[${movie.time_type}]]']").attr("selected",true);
                //时间策略限制
                timeStrategy('[[${movie.time_type}]]')
                
                /* if('[[${batch.cbstatus}]]'=='20'){
                    $(".save").hide();
                } */
                
             $("#quantitys_type").find("option[value='[[${movie.quantitys_key}]]']").attr("selected",true);
             $("#movie_quantitys").show();
             var quantitys_type = '[[${movie.quantitys_key}]]';
             if('[[${batch.coupon_type}]]'!= "2000"){
                 if(quantitys_type == "103" || quantitys_type == "104"){
                     $("#coupons_quantitys").val('[[${movie.quantitys_value}]]');//卡劵数量
                     $("#coupons_quantitys").attr("disabled",false);
                     $("#movie_quantitys").hide();
                  }else if(quantitys_type == "101" || quantitys_type == "102" ){
                    var s="[[${movie.quantitys_value}]]".split('/');
                     coupons_quantitys =  $("#coupons_quantitys").val(s[1]);
                     movie_quantitys =  $("#movie_quantitys").val(s[0]/100);
                     $("#coupons_quantitys").attr("disabled",false);
                     $("#movie_quantitys").attr("disabled",false);
                 }else{
                    $("#coupons_quantitys").attr("disabled",true);
                     $("#movie_quantitys").attr("disabled",true);
                 }
             }
             
                var htmls = "";
                var itemList = '[[${movie.time_value}]]'
                if(itemList!=""){
                var s=itemList.split('/');
                for(var i=0;i<s.length;i++){
                    var time = s[i].split('|');
                    var htmls ="";
                    var times=time[1].split('-');
                    htmls += '<div class="alert alert-success alert-dismissible time_spec_rule" style="float:left;width: 40%; margin-left:30px;">';
                    htmls += '<button type="button"  class="close btn" data-dismiss="alert" >';
                    htmls += '<span aria-hidden="true" class="time_spec_value"  attr_start="' + times[0] + '" attr_end="' + times[1] + '">'+time[1]+'</span>';
                    htmls += '<span class="sr-only">Close</span>';
                    htmls += '</button>';
                    htmls += '<strong>' + time[0] + '</strong>';
                    htmls += '</div>';
                    $("#rule_content1").append(htmls);
                    $("#rule_content").show();
                }
            
               }
               
             $("#coupon_validate_type").val('[[${batch.validate_type}]]');
            //展示兑换类型数据
            $(":radio[name='Sex'][value='[[${batch.coupon_type}]]']").prop("checked", "checked");
            var coupon_types=[[${batch.coupon_type}]]
            var rule_values="";
            if(coupon_types==1000){
                rule_values='[[${movie.rule_value}]]';
                $("#kims_money").val(rule_values);
                $("#kims_money").attr("disabled",false);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true); 
            }if(coupon_types==3000){
                var s='[[${movie.rule_value}]]'.split("/");
                $("#discount_money").val(s[1]);
                $("#discount").val(s[0]);
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",false);
                $("#discount_money").attr("disabled",false);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true); 
            }if(coupon_types==2000){
                var s='[[${movie.rule_value}]]'.split("/");
                $("#exchange_coupons").val(s[0]);
                $("#exchange_movie").val(s[1]);
                $("#exchange_money").val(s[2]);
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",false);
                $("#exchange_movie").attr("disabled",false);                
                $("#exchange_money").attr("disabled",false); 
            }  
          //影片
            $.post("[[${contextPath}]]" + "/common/movieListInfoList", {}, function(data){
                var table = data.obj;
                if (table != null && table != -1) {
                for (var i = 0; i < table.length; i++) {
                    var item = table[i];
                    $("#desi_movie").append("<option value='"+item.label+"'>"+item.value+"</option>");
                    }
                    if('[[${movie.movie_type}]]'!=""){
                    var smovie = '[[${movie.movie_type}]]'.split(',');
                        for(var i=0;i<smovie.length;i++){
                            $('#desi_movie option[value='+smovie[i]+']').attr("selected","selected");
                        }               
                    }
                    $("#desi_movie").select2();
                }
            });
       var store = '[[${movie.stores}]]';
       if(store!=""&&store!=null){
          $("#check_cinema").attr("checked",true);
          data_cinema();
        }else{
         $("#uncheck_cinema").attr("check",true);
        }
        var html1 ="";
        $("#check_cinema").change(function(){
         if(html1==''){
           data_cinema();
         }else{
            $("#check_halls").show();
         }
       })
       //从接口请求数据，动态生成div
       function data_cinema(){
        var url='[[${contextPath}]]/common/hallsList'
        $.post(url,{},function(data){
        if(data.available){
        var table = data.obj;
        for (var i = 0; i < table.length; i++) {
            html1 = '';
            var item = table[i];
            var hall =item.hall;
            html1+='<div name="choose_halls"><input type="checkbox" class="parnter_cinema" name="stroe_value"  id= "i'+item.id+'" attr_id="' + item.id + '" value="" style="width: 15px;height:15px;margin-left:140px;">'+item.CinemaStoreName
            if(hall!=null&&hall!=''){
                 html1+='<div style="margin-left:210px;">'
              for(var j = 0; j < hall.length; j++){
                var hall_data =hall[j];
                html1+='<input  type="checkbox"  class="children_hall'+item.id+'" name="cinema_value" value="default" id="j'+hall_data.id+'" attr_id="' + hall_data.id + '"  style="width: 15px;height:15px;"  >'+hall_data.CinemaHallName +"&nbsp;"
                +"&nbsp;"+"&nbsp;"+"&nbsp;"     
                /* if(j%5==0){
                    
                     html1+='<input  type="checkbox"  class="children_hall" name="cinema_value" value="default" id="j'+hall_data.id+'"  attr_id="' + hall_data.id + '" style="width: 15px;height:15px;margin-left:210px;">'+hall_data.CinemaHallName 
                }else{
                     html1+='<input  type="checkbox"  class="children_hall" name="cinema_value" value="default" id="j'+hall_data.id+'" attr_id="' + hall_data.id + '"  style="width: 15px;height:15px;margin-left:15px;">'+hall_data.CinemaHallName
                } */
              }
                 html1+='</div>'
            }
            html1+='</div>'
            $("#check_halls").append(html1);
            Show_check();
            Clik_check();
            choose_hall(item.id);
           }
          }
         })
       $("#check_halls").show();
     }  
        
     $("#uncheck_cinema").change(function(){
          $("#check_halls").hide();
     })
      //选择影城、影厅   
     function Clik_check(){
        $(".parnter_cinema").click(function(){
           var cinema_indexID=$(this).attr("attr_id");
           var check_status =$(this).is(':checked'); 
           $(".children_hall"+cinema_indexID).each(function() {
             var hall_indexID = $(this).attr("attr_id");
             var cinema_id = hall_indexID.split("-");
             var hall_id =('#j'+hall_indexID);
             if(cinema_id[0]==cinema_indexID){
               if(check_status){
                  $(hall_id).prop("checked",true);
               }else{
                  $(hall_id).removeAttr("checked");
               }
              }
           })
        })
      }
     /* function edit_schema(id, basic_id){
         alert("4444");
     }  */
     function choose_hall(id){
         $(".children_hall"+id).click(function(){
             var cinema_id = $(this).attr("attr_id").split("-")[0]; 
             var close_flag = true ;
             $(".children_hall"+cinema_id).each(function() {
                 //alert(cinema_id)
                 var check_status = $(this).is(':checked');
                 var hall_indexID = $(this).attr("attr_id");
                 var cinema_ids = hall_indexID.split("-");
                 if(cinema_id == cinema_ids[0]){
                     if(check_status){
                         close_flag = false;
                     }
                 }
             });
             if(close_flag){
                 $("#i"+cinema_id).removeAttr("checked");
             }else{
                 $("#i"+cinema_id).prop("checked",true);
             }
         });
     }
     //显示已选择的影城、影厅
     function Show_check(){
        var store = '[[${movie.stores}]]';
        var cinema = '[[${movie.halls}]]'
        var cinema_ids= cinema.split(",");
        var store_id=store.split(",");
        $(".parnter_cinema").each(function(){
          var cinema_indexID=$(this).attr("attr_id");
          for(var i = 0; i < store_id.length; i++){
             if(store_id[i]==cinema_indexID){
              $(this).attr("checked",true);
             }
          }
          var check_status =$(this).is(':checked'); 
        $(".children_hall"+cinema_indexID).each(function() {
            var hall_indexID = $(this).attr("attr_id");
            var cinema_id = hall_indexID.split("-");
            var hall_id =('#j'+hall_indexID);
             if(cinema_id[0]==cinema_indexID){
              if(check_status){
                for(var i = 0; i < cinema_ids.length; i++){
                  if(cinema_ids[i]==hall_indexID){
                    $(hall_id).attr("checked",true);
                  }
                }
              }else{
                 $(hall_id).attr("checked",false);
              }
            }
         })
       })
     }
          
     
     
           //开始日前
            $("#q_sd").datepicker();
            $("#q_sd").datepicker("option", "showAnim", "slideDown");
            $("#q_sd").datepicker("option", "dateFormat", "yy-mm-dd");
            $("#q_ed").datepicker();
            $("#q_ed").datepicker("option", "showAnim", "slideDown");
            $("#q_ed").datepicker("option", "dateFormat", "yy-mm-dd");
            // 初始化为不显示
            /* $("#date").hide();
            $("#weeks").hide();
            $("#time1").hide();
            $("#rule_content").hide();
            var v = $("#time_policy").val();
            timeStrategy(v) */
           });
        $("#coupon_app").on("change", function() {
            var tv = $(this).val();
            //cstriger_coupon_app(tv);
        });          
         $(document).ready(function () {
             var tv= $("#coupon_app").val();
             //triger_coupon_app(tv);
         });         
        $("#coupon_app").val('[[${batch.crapp}]]');
 
        // 输入框的初始化
        initialCoupons();
        // 代换类型选择
         
        $("input[name=Sex]").on("change", function() {
            var v = $(this).val();      
            if(v == "1000"){    
                //layer.msg($("#kims_money").attr("style")+"asdasd", {icon: 2});
                $("#kims_money").attr("disabled",false);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true);         
            }else if(v == "3000"){
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",false);
                $("#discount_money").attr("disabled",false);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true);     
            }else if(v == "2000"){      
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",false);
                $("#exchange_movie").attr("disabled",false);                
                $("#exchange_money").attr("disabled",false);        
            }
            emptiedCoupons();
        });
      //添加一条时间策略的判断
        $(".add_time_stregy").on("click", function() {
            var time_policy = $("#time_policy").val();
            if(time_policy=="0") {
                layer.msg("该时间策略不可添加具体限制值", {icon: 2});
                return;
            }
            var choose_week = null;
            var choose_week_dis_name = null;
            if(time_policy=="w") {
                $(".week_day").each(function() {
                    if($(this).is(':checked')) {
                        choose_week = choose_week==null?$(this).val():choose_week + "," + $(this).val();
                        choose_week_dis_name = choose_week_dis_name==null?$(this).attr("dis_name"):choose_week_dis_name + "," + $(this).attr("dis_name");
                    }
                });
            } else if(time_policy=="d") {
                //选择日期类型，获取开始日期，结束日期
                var q_sd = $("#q_sd").val();
                var q_ed = $("#q_ed").val();
                if(q_sd==null||q_sd==""||q_ed==null||q_ed=="") {
                    layer.msg("请设置开始日期和结束日期", {icon: 2});
                    return;
                }
                
                choose_week = q_sd + "," + q_ed;
                choose_week_dis_name = q_sd + "——" + q_ed;
            }
            var start_time = $.trim($("#start_time").val());
            var end_time = $.trim($("#end_time").val());
            var q_sd = $("#q_sd").val();
            var q_ed = $("#q_ed").val();
            if(q_sd){
                var start_date= q_sd.split('-');
                var end_date=q_ed.split('-');
                var sts = start_time.split(":");
                var ets = end_time.split(":");
                if(parseInt(start_date[0]+start_date[1]+start_date[2])>parseInt(end_date[0]+end_date[1]+end_date[2])) {
                  layer.msg("结束日期比须大于开始日期", {icon: 2});
                  return;
                }else if(parseInt(start_date[0]+start_date[1]+start_date[2])==parseInt(end_date[0]+end_date[1]+end_date[2])){
                    if(parseInt(sts[0]+sts[1])>=parseInt(ets[0]+ets[1])){
                        layer.msg("结束时间比须大于开始时间", {icon: 2});
                        return;
                    }
                } 
            }else{
             if(choose_week==null) {
                 layer.msg("请勾选价格策略执行的星期值", {icon: 2});
                 return;
             }
             if(start_time==null||start_time=="") {
                 start_time = null;
             }
             if(end_time==null||end_time=="") {
                 end_time = null;
             }
            
             if((start_time==null&&end_time!=null)||(start_time!=null&&end_time==null)) {
                 layer.msg("请选择开始时间结束时间", {icon: 2});
                 return;
             }
             if(start_time==null||end_time==null) {
                 layer.msg("请选择开始时间结束时间", {icon: 2});
                 return;
             }
             var sts = start_time.split(":");
             var ets = end_time.split(":");
             if(parseInt(sts[0])>parseInt(ets[0])) {
                layer.msg("结束时间须大于开始时间", {icon: 2});
                return;
             } else if(parseInt(sts[0])==parseInt(ets[0])) {
                if(parseInt(sts[1])>=parseInt(ets[1])) {
                    layer.msg("结束时间须大于开始时间", {icon: 2});
                    return;
                }
             }
            }
            var html = '<div class="alert alert-success alert-dismissible time_spec_rule" style="float:left;width: 40%; margin-left:30px;">';
            html = html + '<button type="button" class="close" data-dismiss="alert">';
            if(start_time!=null) {
                html = html + '<span aria-hidden="true" class="time_spec_value" attr_start="' + start_time + '" attr_end="' + end_time + '">' + start_time + '-' + end_time + '</span>';
            } else {
                html = html + '<span aria-hidden="true">&times;</span>';
            }
            html = html + '<span class="sr-only">Close</span>';
            html = html + '</button>';
            html = html + '<strong attr_v="' + choose_week + '">' + choose_week_dis_name + '</strong>';
            html = html + '</div>';
            
        
            $("#rule_content1").append(html);
            $("#start_time").val("");
            $("#end_time").val("");
            $("#q_sd").val("");
            $("#q_ed").val("");
            $("#rule_content").show();
        });
       /*  init();  */
   function emptiedCoupons(){
            $("#kims_money").val("");
            $("#kims_money").val("");
            $("#discount").val("");
            $("#discount_money").val("");
            $("#exchange_coupons").val("");
            $("#exchange_movie").val("");       
            $("#exchange_money").val("");
        }
        
        // 输入框的初始化
        function initialCoupons(){
            /* var mc_l_ht_list = "${available_tags }";
            //layer.msg(mc_l_ht_list.length, {icon: 2});
            var itemList = JSON.parse(mc_l_ht_list);
            $.each(itemList,function(key,vara){
                $("#v_mc_l_cs_v").append("<option value=\""+vara.key+"\">"+vara.map+"</option>");
            }); */
            
            $("#kims_money").attr("checked","checked");
            $("#discount").attr("checked","");
            $("#discount_money").attr("checked","");
            $("#exchange_coupons").attr("checked","");
            $("#exchange_movie").attr("checked","");                
            $("#exchange_money").attr("checked","");    
            var val = $('input:radio[name="Sex"]:checked').val();
            
            if(val == "3000"){
            
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",false);
                $("#discount_money").attr("disabled",false);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true); 
                
            }else if(val == "2000"){
                $("#kims_money").attr("disabled",true);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",false);
                $("#exchange_movie").attr("disabled",false);                
                $("#exchange_money").attr("disabled",false);    
            }else{
                $("#kims_money").attr("disabled",false);
                $("#discount").attr("disabled",true);
                $("#discount_money").attr("disabled",true);
                $("#exchange_coupons").attr("disabled",true);
                $("#exchange_movie").attr("disabled",true);             
                $("#exchange_money").attr("disabled",true); 
            }
            if(val == '2000'){
                 //alert("3--00");
                $("#coupons_quantitys").attr("disabled",true);
                $("#movie_quantitys").attr("disabled",true);
                return;
            }
            
            var v  = '[[${movie.quantitys_key}]]';
            if(v==''){
                v = 100;
            }
            $("#quantitys_type").find("option[value='[[${movie.quantitys_key}]]']").attr("selected",true);
            showQuantitys(v);
        }

        $("#quantitys_type").on("change", function() {
            var v = $(this).val();
            var type  = $('input:radio[name="Sex"]:checked').val();
            if(type == "2000"){
                $("#coupons_quantitys").attr("disabled",true);
                $("#movie_quantitys").attr("disabled",true);
                return ;
            }
            showQuantitys(v);
        });
        
        
        function showQuantitys(v){
            /*100 : 无
            *101 : 满
            *102 : 每满
            *103 : 每笔
            *104 : 每张
            */
            //alert($("#description").attr("id"))
            if(v == "100" ){
                $("#coupons_quantitys").attr("disabled",true);
                $("#movie_quantitys").show();
                $("#movie_quantitys").attr("disabled",true);
                $("#description").html("最多可用");
            }else if(v == "103"){
                $("#coupons_quantitys").attr("disabled",false);
                $("#movie_quantitys").hide();
                $("#description").html("交易最多可用");
            }else if(v == "104" ){
                $("#coupons_quantitys").attr("disabled",false);
                $("#movie_quantitys").hide();
                $("#description").html("张电影票最多可用");
            }else{         
                $("#coupons_quantitys").attr("disabled",false);
                $("#movie_quantitys").show();
                $("#movie_quantitys").attr("disabled",false);
                $("#description").html("元最多可用");
            }
            //alert(v) 
            if(v == "101" || v == "102" ){
                $("#movie_quantitys").val("");
                $("#movie_quantitys").attr("placeholder","保留两位小数");
                $("#coupons_quantitys").val("");
                $("#coupons_quantitys").attr("placeholder","请输入整数"); 
            }else if(v == "104"|| v=="103"){
                $("#movie_quantitys").val("");
                $("#movie_quantitys").attr("placeholder","");
                $("#coupons_quantitys").val("");
                $("#coupons_quantitys").attr("placeholder","请输入整数"); 
            }else{
                $("#movie_quantitys").val("");
                $("#movie_quantitys").attr("placeholder","");
                $("#coupons_quantitys").val("");
                $("#coupons_quantitys").attr("placeholder",""); 
            }
        }
        
        $(":radio").click(function(){
            var type = $(this).val();
            var v = $("#quantitys_type").val();
            if(type == '2000'){
                 //alert("3--00");
                $("#coupons_quantitys").attr("disabled",true);
                $("#movie_quantitys").attr("disabled",true);
            }else{          
                $("#coupons_quantitys").attr("disabled",true);
                $("#movie_quantitys").attr("disabled",true);            
            }
         });
    </script>
    <script>
    var coupon_id = '[[${batch.id }]]';
    $(".save").on("click", function(){
    var id = coupon_id || null;
   // var batch_crapp = "${batch.crapp }";
    var coupon_title = $("#coupon_title").val().trim();
    var coupon_validate_type = $("#coupon_validate_type").val();
    var coupon_validate_period = $("#coupon_validate_period").val().trim();
    var coupon_info = $("#coupon_info").val().trim();           
    var coupon_crapp ='[[${batch.crapp}]]';   
  /*   var mc_l_htt = $("#mc_l_htt").val(); */
  /*   var mc_l_ht = "";
        $("#mc_l_ht option:selected").each(function(){
            if(mc_l_ht){mc_l_ht += ",";}
            mc_l_ht += $(this).val();
        });          */
        var coupon_use_con_ss = "";
        $("input[name='stroe_value']:checked").each(function(){
            if(coupon_use_con_ss){coupon_use_con_ss += ",";}
            coupon_use_con_ss += $(this).attr("attr_id");
        }); 
        var desi_movie_hall="";
        $("input[name='cinema_value']:checked").each(function(){
            if(desi_movie_hall){desi_movie_hall += ",";}
            desi_movie_hall += $(this).attr("attr_id");
        });
        var check_cinema =$("#check_cinema").is(':checked'); 
        if(check_cinema){
            if(coupon_use_con_ss==null||coupon_use_con_ss==''){
                layer.msg("当前影城不可为空", {icon: 2});
                return;
            }
        }
        var desi_movie="";
        var desi_movie_info = "";
        $("#desi_movie option:selected").each(function(){
            if(desi_movie){desi_movie += ",";}
            if(desi_movie_info){desi_movie_info += ",";}
            desi_movie += $(this).val();
            desi_movie_info +=$(this).html();
        });
        // $("#v_mc_l_ms").find("<option value=''>"++"</option>");
       /*  var v_mc_l_ms = "";
        $("#v_mc_l_ms option:selected").each(function(){
            if(v_mc_l_ms){v_mc_l_ms += ",";}
            v_mc_l_ms += $(this).val();
        }); */
        
        //$("#v_mc_l_ms option:selected").val(m_movie)
        
        var coupon_val = $("#coupon_val").val();            
        var coupon_no = $("#coupon_no").val();          
        var coupon_img = "";
        var coupon_content = editor.html();                 
        if(coupon_title==null||coupon_title=="") {
            layer.msg("请输入卡券名称", {icon: 2});
            return;
        }
        
                
        if(coupon_info==null||coupon_info=="") {
            layer.msg("请输入卡券描述", {icon: 2});
            return;
        }
        if(coupon_validate_type=="0010") {
            var DATE_FORMAT = /^[0-9]{4}-[0-1]?[0-9]{1}-[0-3]?[0-9]{1} [0-2]?[0-9]{1}:[0-5]?[0-9]{1}:[0-5]?[0-9]{1}$/;
            if(!DATE_FORMAT.test(coupon_validate_period)){
                layer.msg("请设置失效日期", {icon: 2});
                return;
            }
        } else if(coupon_validate_type=="1001") {
            if(coupon_validate_period==null||coupon_validate_period.trim()==""||isNaN(coupon_validate_period)||parseInt(coupon_validate_period)<=0) {
                layer.msg("请设置领用后失效天数", {icon: 2});
                return;
            }
        } else if(coupon_validate_type=="0000") {
            coupon_validate_period = "0";
        }
        if(coupon_validate_type=="0000") {
            $("#coupon_validate_period").val("0");
        }
        if(coupon_validate_type=="0000"&&coupon_validate_period!="0") {
            layer.msg("永久有效类卡券卡券领用后阈值应为0", {icon: 2});
            return;
        }
        if(coupon_validate_type=="1001"||coupon_validate_type=="1002"||coupon_validate_type=="1003") {
            if(coupon_validate_period==""||isNaN(coupon_validate_period)) {
                layer.msg("永久有效类卡券卡券领用后阈值应为大于0的有效数字", {icon: 2});
                return;
            } else {
                coupon_validate_period = parseInt(coupon_validate_period);
                if(coupon_validate_period<=0) {
                    layer.msg("永久有效类卡券卡券领用后阈值应为大于0的有效数字", {icon: 2});
                    return;
                }
            }
        } else if(coupon_validate_type=="0010") {
            //为统一时间，则应该输入日期
            if(coupon_validate_period==""||!isNaN(coupon_validate_period)) {
                layer.msg("永久有效类卡券卡券领用后阈值应为有效的日期", {icon: 2});
                return;
            }
        }
       
        
        // 根据兑换类型拼接数据
        var rulse_map = "";
        var reg = new RegExp("^([1-9][0-9]*\.[0-9][0-9])$");
        var reg1 = new RegExp("^([1-9][0-9]*)$");
        
        var  exchange_tpye = "";  //卡劵兑换类型
        var val_radio = $('input:radio[name="Sex"]:checked').val();
         if(val_radio == "1000"){
             var kims_money = $("#kims_money").val();           
             if(!reg.test(kims_money)){
                    layer.msg("请输入正确的折扣金额", {icon: 2});
                    return;
             }
             rulse_map = kims_money;
             exchange_tpye = "1000";
         }else if(val_radio == "3000"){
            var  reg2 = new RegExp("^([0-9][0-9]*\.[0-9][0-9])$");
            var discount = $("#discount").val();
             
            var discount_money = $("#discount_money").val();
             
            if(!reg1.test(discount)){
                    layer.msg("请输入正确的折扣", {icon: 2});
                    return;
             }
             
             if( discount_money != null  && discount_money != ""  &&  !reg2.test(discount_money)){
                    layer.msg("请输入正确的折扣金额", {icon: 2});
                    return;
             }  
             
             if(discount_money == null ||  discount_money == ""){
                 discount_money == "";
             }
             rulse_map = discount + "/" +discount_money;     
             exchange_tpye = "3000";
         }else if(val_radio == "2000"){ //兑换
             var  reg2 = new RegExp("^([0-9][0-9]*\.[0-9][0-9])$");
             var exchange_coupons = $("#exchange_coupons").val();
             var exchange_movie = $("#exchange_movie").val();
             var exchange_money = $("#exchange_money").val();                
             if(!reg1.test(exchange_coupons)){// 整数
                    layer.msg("请输入正确的兑换卡劵数量"+exchange_coupons, {icon: 2});
                    return;
             }
             if(!reg1.test(exchange_movie)){ // 整数
                    layer.msg("请输入正确的兑换电影票数量"+exchange_movie, {icon: 2});
                    return;
             }
             if( exchange_money != null  && exchange_money != ""  &&  !reg2.test(exchange_money)){
                 layer.msg("请输入正确的兑换补差金额", {icon: 2});
                 return;
             }  
          
             if(exchange_money == null ||  exchange_money == ""){
                 exchange_money == "";
             }
             rulse_map = exchange_coupons + "/" + exchange_movie + "/" + exchange_money;
             exchange_tpye = "2000";
         }else{
             layer.msg("代折、扣合、兑换、请至少选择一种方式", {icon: 2});
             return ; 
         }
        /* 
         
        //是否保护最低价
        var p_lowest = "1";// 保护

        var p_lowess = $("#p_lowest").is(':checked')
        if(!p_lowess){
            p_lowest = "2";
        } */
       
        //兑换的数量规则
       var quantitys_type = $("#quantitys_type").val();
       var  coupons_quantitys = null;
       var  movie_quantitys   = null;
        //return;
        //var reg2 = new RegExp("^([0-9][0-9]*\.[0-9][0-9])$");
        //reg 是浮点数   re1是整数
        if(val_radio != "2000"){
            if(quantitys_type == "103"){
                coupons_quantitys =  $("#coupons_quantitys").val();//卡劵数量
                movie_quantitys =  $("#movie_quantitys").val();
                if(!reg1.test(coupons_quantitys) ){
                    layer.msg("请输入正确的数量策略卡劵数量", {icon: 2});
                    return ; 
                }
             }else if(quantitys_type == "101" || quantitys_type == "102" ){
                coupons_quantitys =  $("#coupons_quantitys").val();
                movie_quantitys =  $("#movie_quantitys").val();
                if( !reg.test(movie_quantitys)){
                    layer.msg("请输入正确的数量策略金额格式", {icon: 2});
                    return ; 
                }
                if(!reg1.test(coupons_quantitys) ){
                    layer.msg("请输入正确的数量策略卡劵数量", {icon: 2});
                    return ; 
                }
            }else if(quantitys_type == "104" ){
                coupons_quantitys =  $("#coupons_quantitys").val();
                movie_quantitys =  $("#movie_quantitys").val();
                movie_quantitys = "1";
                if(!reg1.test(coupons_quantitys)){
                    layer.msg("请输入正确的数量策略卡劵数量", {icon: 2});
                    return ; 
                }
            }else{
                quantitys_type = "100"
            }
        }
        if(val_radio == "2000"){
             quantitys_type = "100";
        }
        
       //设置时间策略
       var spru_time_spec = null;
       var spru_time_type  = $("#time_policy").val();
        $(".time_spec_rule").each(function() {
            var week_days = $(this).find("strong").text();
            var start = $(this).find(".time_spec_value").attr("attr_start");
            var end = $(this).find(".time_spec_value").attr("attr_end");
            
            var  times =  week_days + "|" + start + "-" + end ;
            spru_time_spec = spru_time_spec==null?times:spru_time_spec + "/" + times;
            
        });
       
        if (spru_time_type != "0"  && (spru_time_spec == null || spru_time_spec == "" )) {
            layer.msg("请设置时间策略", {icon: 2});
            return;
        }
     /*    mc_l_ht = $("#mc_l_ht").find("option:selected").text(); */
        var index = layer.load(0, {shade: false});
        var url = '[[${contextPath}]]/coupon/batch/do_add_online/?' + Date.parse(new Date());
        $.post(url, {
                    id:id,
                    coupon_no:coupon_no,  // 批次编号
                    coupon_title:coupon_title, //卡劵名称
                    coupon_info:coupon_info,  //卡劵描述
                    coupon_crapp:coupon_crapp,
                    coupon_img:coupon_img,
                    coupon_content:coupon_content,                          
                    coupon_use_con_gs:desi_movie, // 影片类型
                    coupon_use_val_gs:desi_movie_hall,  //影厅类型
                    coupon_use_con_ss:coupon_use_con_ss,  //   限制影城
                    coupon_use_val_ss:desi_movie_info,  //  限制影片
                  //  batch_crapp:batch_crapp, //  在线                 
                    p_lowest:"0",  //是否保护最低价
                    quantitys_type:quantitys_type,//兑换的数量规则
                    coupons_quantitys:coupons_quantitys,// 卡劵数量
                    movie_quantitys:movie_quantitys,//电影数量
                    spru_time_type:spru_time_type,//时间策略类型
                    spru_time_spec:spru_time_spec,// 时间策略参数
                    exchange_tpye:exchange_tpye,// 卡劵兑换类型   兑换 折扣 代金
                    rule_map:rulse_map,  //  兑换参数
                    coupon_validate_type:coupon_validate_type,
                    coupon_validate_period:coupon_validate_period,
                    }, 
            function(data){
                layer.close(index);
                if(data.available) {
                    layer.alert('操作成功', {
                        skin: 'layui-layer-lan',
                        shift: 4 //动画类型
                    }, function(){
                        location.href = '[[${contextPath}]]/coupon/index/?' + Date.parse(new Date());
                    });
                } else {
                    var code = data.messages[0];
                    var msg = "未知错误";
                    layer.msg(code, {
                        shift : 6
                    });
                }
        });
    });
    </script>
    <script>
            //开始时间
            $("#start_time").datetimepicker({
                timeOnly:true,
                datepicker:false,
                step:5,
                format:'H:i',
                onShow:function( currentDateTime ){
                this.setOptions({
                maxTime:$(".enddatepicker").val()?$(".enddatepicker").val():false
                });
                },
                onChangeDateTime:function( currentDateTime ){
                this.setOptions({
                maxTime:$(".enddatepicker").val()?$(".enddatepicker").val():false
                });
                }
            });
            
            // 结束时间
            $("#end_time").datetimepicker({
                timeOnly:true,
                datepicker:false,
                step:5,
                format:'H:i',
                onShow:function( currentDateTime ){
                this.setOptions({
                maxTime:$(".enddatepicker").val()?$(".enddatepicker").val():false
                });
                },
                onChangeDateTime:function( currentDateTime ){
                this.setOptions({
                maxTime:$(".enddatepicker").val()?$(".enddatepicker").val():false
                });
                }
            });
            
            // 时间段的选择方式
            $("#time_policy").on("change", function() {
                var v = $(this).val();
                //xslayer.msg("该时间策略不可添加具体限制值", {icon: 2});
                timeStrategy(v);
            });

            function timeStrategy(v){
                if(v=="w") {     //按周分时设置 
                    $("#date").hide();
                    $("#weeks").show();
                    $("#time1").show();
                    
                } else if(v=="d") {   //  按日分时设置
                    $("#date").show();
                    $("#weeks").hide();
                    $("#time1").show();
                    
                }else{  // 全天有效
                    $("#date").hide();
                    $("#weeks").hide();
                    $("#time1").hide();
                    $("#rule_content").hide();
                }
                $("#rule_content1").html("");
                $("#rule_content").hide();
            } 
    </script>
</html>
